<aside
  class="sheet"
  [class.scrollable]="isExpanded() && showReviews()"
  role="dialog"
  aria-modal="true"
  aria-labelledby="wc-sheet-title"
  (click)="onSheetClick($event)"
>
  <button
    type="button"
    class="handle-button"
    (click)="onExpand()"
    aria-label="Expandir o contraer"
  >
    <span class="handle"></span>
  </button>
  <button
    #closeButton
    type="button"
    class="close-button"
    (click)="onClose()"
    aria-label="Cerrar"
  >
    Ã—
  </button>
  <h2 id="wc-sheet-title" class="title" (click)="onExpand()">{{ wc().name }}</h2>
  @if (distanceLabel()) {
    <p class="distance muted">{{ distanceLabel() }}</p>
  }

  <app-wc-feature-icons [wc]="wc()" />

  @if (isExpanded()) {
  <div class="actions">
  </div>
    <div class="ratings">
      <div class="rating">
        <span class="label">Limpieza</span>
        <div class="rating-visual">
          <span class="stars" [attr.aria-label]="cleanlinessAria()">
            {{ cleanlinessStars() }}
          </span>
          @if (wc().reviews_count > 0) {
            <span class="rating-number">
              {{ wc().avg_cleanliness | number: '1.1-1' }}
            </span>
          } @else {
            <span class="rating-number muted">Sin valoraciones</span>
          }
        </div>
      </div>

      <div class="rating">
        <span class="label">Privacidad</span>
        <div class="rating-visual">
          <span class="stars" [attr.aria-label]="safetyAria()">
            {{ safetyStars() }}
          </span>
          @if (wc().reviews_count > 0) {
            <span class="rating-number">
              {{ wc().avg_safety | number: '1.1-1' }}
            </span>
          } @else {
            <span class="rating-number muted">Sin valoraciones</span>
          }
        </div>
      </div>

      <div class="reviews-count">
        @if (wc().reviews_count > 0) {
          <span class="reviews-text">ðŸ’¬ {{ wc().reviews_count }} reviews</span>
        } @else {
          <span class="reviews-text muted">Sin valoraciones</span>
        }
      </div>
    </div>

    <div class="cta">
      <button
        type="button"
        class="primary"
        (click)="onToggleReviews()"
        [attr.aria-expanded]="showReviews()"
        aria-controls="sheet-reviews"
      >
        {{ showReviews() ? 'Ocultar reviews' : 'Ver reviews' }}
      </button>
      <button
        type="button"
        class="secondary"
        [routerLink]="['/wcs', wc().id]"
        (click)="$event.stopPropagation()"
      >
        Ver detalle del WC
      </button>
    </div>

    @if (showReviews()) {
      <section class="reviews" id="sheet-reviews">
        @if (reviewsLoading()) {
          <p class="muted">Cargando reviews...</p>
        } @else if (reviewsError()) {
          <p class="muted">{{ reviewsError() }}</p>
        } @else if (reviews().length === 0) {
          <p class="muted">TodavÃ­a no hay reviews</p>
        } @else {
          <ul class="review-list">
            @for (review of visibleReviews(); track review.id) {
              <li class="review-item">
                <div class="review-metrics">
                  <div class="review-metric">
                    <span class="review-label">Limpieza</span>
                    <span
                      class="review-stars"
                      [attr.aria-label]="'Limpieza: ' + review.cleanliness_rating + ' de 5'"
                    >
                      {{ reviewStars(review.cleanliness_rating) }}
                    </span>
                    <span class="review-score">
                      {{ review.cleanliness_rating }}/5
                    </span>
                  </div>
                  <div class="review-metric">
                    <span class="review-label">Privacidad</span>
                    <span
                      class="review-stars"
                      [attr.aria-label]="'Privacidad: ' + review.safety_rating + ' de 5'"
                    >
                      {{ reviewStars(review.safety_rating) }}
                    </span>
                    <span class="review-score">
                      {{ review.safety_rating }}/5
                    </span>
                  </div>
                </div>
                @if (review.comment) {
                  <p class="review-comment">{{ review.comment }}</p>
                }
                @if (review.created_at) {
                  <span class="review-date">
                    {{ review.created_at | date: 'dd/MM/yy' }}
                  </span>
                }
              </li>
            }
          </ul>
          @if (hasMoreReviews()) {
            <a
              class="secondary-cta"
              [routerLink]="['/wcs', wc().id]"
              (click)="$event.stopPropagation()"
            >
              Ver todas las reviews ({{ wc().reviews_count }})
            </a>
          }
        }
      </section>
    }
  }
</aside>
